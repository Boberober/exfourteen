app.controller("MainCtrl",function(t,r,e,a,g){t.user=g,t.btnText="Logga in med Facebook",t.showButton=!1,t.$watch(function(){return e.isReady()},function(){t.facebookReady=!0}),e.getLoginStatus(function(r){t.showButton=!0,"connected"==r.status&&(t.btnText="Hämta profilbild",t.logged=!0)}),t.authenticate=function(){setTimeout(function(){t.error="Psst! Se till att du inte har popups avstängda!"},500);e.login(function(r){"connected"==r.status?(t.logged=!0,a.path("/profilbild")):a.path("/")},{scope:"publish_stream,photo_upload,user_photos"})}}).controller("CoverCtrl",function(){}).controller("ProfileCtrl",function(t,r,e,a,g,o){t.profile="",t.loading=!0,t.resultSource="gello",t.error="",e.getLoginStatus(function(r){"connected"==r.status?(t.logged=!0,t.me()):t.login()}),t.login=function(){e.login(function(r){"connected"==r.status?(t.logged=!0,t.me()):a.path("/")},{scope:"publish_stream,photo_upload,user_photos"})},t.uploadImage=function(){$loading=!0,r.post("/upload",{imgData:t.resultSource,id:t.user.id}).success(function(t){$loading=!1,window.location.assign(t.path)}).error(function(){t.error="Ajaj, något gick snett. Sorry 'bout that."})},t.hasError=function(){return""!==t.error?!0:!1},t.checkAlbums=function(){1===t.user.permissions.data[0].photo_upload&&(t.loading=!0,r.post("/upload",{imgData:t.resultSource,id:t.user.id}).success(function(r){var g=(r.name,window.location.origin+r.path);console.log(g),e.api("/me?fields=albums",function(r){if(r.hasOwnProperty("albums")){for(var i=r.albums.data,n={},s={},d=i.length-1;d>=0&&(jQuery.isEmptyObject(n)||jQuery.isEmptyObject(s));d--)"Cover Photos"===i[d].name&&(s=i[d]),"Profile Pictures"===i[d].name&&(n=i[d]);e.api("/"+n.id+"/photos","post",{url:g},function(r){t.loading=!1,console.log(r),r.hasOwnProperty("error")?(ga("send","profile_upload_error"),t.error="Ajaj, något gick snett. Sorry 'bout that."):(a.path("/klar"),t.fbUrl="http://www.facebook.com/photo?fbid="+r.id+"&makeprofile=1&makeuserprofile=1",window.location=t.fbUrl,ga("send","profile_upload"),o.setUrl(t.fbUrl))})}})}).error(function(){t.error="Ajaj, något gick snett. Sorry 'bout that."}))},t.me=function(){e.api("/me?fields=first_name,permissions,picture.height(500)",function(r){t.user=r,o.setUser(t.user),console.log(t.user);var e=r.picture.data.url;dragger={imgUrl:e,img:{},targetWidth:1250,canvas:document.getElementById("canvas"),ctx:canvas.getContext("2d"),isDragging:!1,startDrag:{x:0,y:0},imgPos:{x:0,y:0},init:function(){dragger.img=document.createElement("IMG"),dragger.img.crossOrigin="Anonymous",dragger.img.onload=function(){dragger.img.width<dragger.targetWidth&&console.log("oj, vad liten bild du har.. ajjajaj"),dragger.transformImage({},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})}),canvas.addEventListener("mousedown",function(t){dragger.isDragging=!0;try{dragger.startDrag.x=t.offsetX-dragger.startDrag.x,dragger.startDrag.y=t.offsetY-dragger.startDrag.y}catch(t){console.log(t)}}),canvas.addEventListener("mouseup",function(r){dragger.startDrag.x=dragger.imgPos.x,dragger.startDrag.y=dragger.imgPos.y,dragger.isDragging=!1,dragger.transformImage({ev:r,startDrag:{x:dragger.startDrag.x,y:dragger.startDrag.y}},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})})}),canvas.addEventListener("mousemove",function(r){isNaN(dragger.startDrag.x)&&(dragger.startDrag={x:0,y:0}),dragger.isDragging&&dragger.transformImage({ev:r,startPos:dragger.startDrag},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})})})},dragger.img.src=dragger.imgUrl,(dragger.img.complete||void 0===dragger.img.complete)&&(dragger.img.src=dragger.imgUrl)},transformImage:function(t,r){var e=dragger.canvas,a=dragger.ctx,g=r,o=dragger.img,s=0;o.crossOrigin="Anonymous",e.height=o.height,e.width=o.width,a.globalCompositeOperation="normal",a.fillStyle="#fff",a.fillRect(0,0,e.width,e.height),a.fill();var d=e.width>=e.height?"width":"height",l="width"===d?"height":"width",u=o[l]/o[d];o[l]=o[l]>dragger.targetWidth?dragger.targetWidth:o[l],o[l]=dragger.targetWidth,o[d]=o[l]/u;var c=.2*dragger.targetWidth;console.log(c),s=c,e[l]=dragger.targetWidth,e[d]=dragger.targetWidth;var h=document.createElement("canvas");h.width=e.width,h.height=e.height;var m=h.getContext("2d");m.translate(.5,.5),m.fillStyle="white",m.strokeStyle="#000",m.fillRect(0,0,h.width,h.height),m.globalCompositeOperation="destination-out",a.drawImage(h,0,0),a.moveTo(s/2,e.height/4),a.lineTo(e.width/2,0),a.lineTo(e.width-s/2,e.height/4),a.lineTo(e.width-s/2,e.height-e.height/4),a.lineTo(e.width/2,e.height),a.lineTo(s/2,e.height-e.height/4),a.lineTo(s/2,e.height/4),a.strokeStyle="#fff",a.lineWidth=5,a.stroke(),a.clip(),dragger.isDragging&&(i=t.ev.layerX-dragger.startDrag.x,n=t.ev.layerY-dragger.startDrag.y),i>s/2&&(i=s/2),i+o.width<e.width-s/2&&(i=e.width-s/2-o.width),a.drawImage(o,i,0,o.width,o.height),dragger.imgPos.x=i,dragger.imgPos.y=n;var f=a.getImageData(0,0,e.width,e.height),p=f.data;if(!dragger.isDragging)for(var w=0,y=p.length;y>w;w+=4){var v=.3*p[w]+.59*p[w+1]+.11*p[w+2];p[w]=v,p[w+1]=v,p[w+2]=v}if(a.putImageData(f,0,0),!dragger.isDragging){var D=document.createElement("IMG");D.onload=function(){D.width=e.width,D.height=e.height,a.drawImage(D,0,0,e.width,e.height),g(e.toDataURL("image/png"))},D.src="images/overlay.png",a.restore()}}},dragger.init(),t.$apply(function(){t.user=r,o.setUser(t.user)})})};var i=0,n=0}).controller("DoneCtrl",function(t,r,e,a,g){t.user=g.getUser(),t.fbUrl=g.getUrl()}),app.controller("DoneCtrl",function(t,r,e,a,g){t.user=g.getUser(),t.fbUrl=g.getUrl()}),app.controller("MainCtrl",function(t,r,e,a,g){t.user=g,t.btnText="Logga in med Facebook",t.showButton=!1,t.$watch(function(){return e.isReady()},function(){t.facebookReady=!0}),e.getLoginStatus(function(r){t.showButton=!0,"connected"==r.status&&(t.btnText="Hämta profilbild",t.logged=!0)}),t.authenticate=function(){setTimeout(function(){t.error="Psst! Se till att du inte har popups avstängda!"},500);e.login(function(r){"connected"==r.status?(t.logged=!0,a.path("/profilbild")):a.path("/")},{scope:"publish_stream,photo_upload,user_photos"})}}),app.controller("ProfileCtrl",function(t,r,e,a,g){t.profile="",t.loading=!0,t.resultSource="",t.error="",e.getLoginStatus(function(r){"connected"==r.status?(t.logged=!0,t.me()):t.login()}),t.login=function(){e.login(function(r){"connected"==r.status?(t.logged=!0,t.me()):a.path("/")},{scope:"publish_stream,photo_upload,user_photos"})},t.uploadImage=function(){$loading=!0,r.post("/upload",{imgData:t.resultSource,id:t.user.id}).success(function(t){$loading=!1,window.location.assign(t.path)}).error(function(){t.error="Ajaj, något gick snett. Sorry 'bout that."})},t.hasError=function(){return""!==t.error?!0:!1},t.checkAlbums=function(){1===t.user.permissions.data[0].photo_upload&&(t.loading=!0,r.post("/upload",{imgData:t.resultSource,id:t.user.id}).success(function(r){var o=(r.name,window.location.origin+r.path);e.api("/me?fields=albums",function(r){if(r.hasOwnProperty("albums")){for(var i=r.albums.data,n={},s={},d=i.length-1;d>=0&&(jQuery.isEmptyObject(n)||jQuery.isEmptyObject(s));d--)"Cover Photos"===i[d].name&&(s=i[d]),"Profile Pictures"===i[d].name&&(n=i[d]);e.api("/"+n.id+"/photos","post",{url:o},function(r){t.loading=!1,r.hasOwnProperty("error")?(ga("send","profile_upload_error"),t.error="Ajaj, något gick snett. Sorry 'bout that."):(a.path("/klar"),t.fbUrl="http://www.facebook.com/photo?fbid="+r.id+"&makeprofile=1&makeuserprofile=1",window.location=t.fbUrl,ga("send","profile_upload"),g.setUrl(t.fbUrl))})}})}).error(function(){t.error="Ajaj, något gick snett. Sorry 'bout that."}))},t.me=function(){e.api("/me?fields=first_name,permissions,picture.height(500)",function(r){t.user=r,g.setUser(t.user);var e=r.picture.data.url;dragger={imgUrl:e,img:{},targetWidth:1250,canvas:document.getElementById("canvas"),ctx:canvas.getContext("2d"),isDragging:!1,startDrag:{x:0,y:0},imgPos:{x:0,y:0},init:function(){dragger.img=document.createElement("IMG"),dragger.img.crossOrigin="Anonymous",dragger.img.onload=function(){dragger.img.width<dragger.targetWidth&&console.log("oj, vad liten bild du har.. ajjajaj"),dragger.transformImage({},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})}),canvas.addEventListener("mousedown",function(t){dragger.isDragging=!0;try{dragger.startDrag.x=t.offsetX-dragger.startDrag.x,dragger.startDrag.y=t.offsetY-dragger.startDrag.y}catch(t){console.log(t)}}),canvas.addEventListener("mouseup",function(r){dragger.startDrag.x=dragger.imgPos.x,dragger.startDrag.y=dragger.imgPos.y,dragger.isDragging=!1,dragger.transformImage({ev:r,startDrag:{x:dragger.startDrag.x,y:dragger.startDrag.y}},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})})}),canvas.addEventListener("mousemove",function(r){isNaN(dragger.startDrag.x)&&(dragger.startDrag={x:0,y:0}),dragger.isDragging&&dragger.transformImage({ev:r,startPos:dragger.startDrag},function(r){t.loading=!1,t.$apply(function(){t.resultSource=r})})})},dragger.img.src=dragger.imgUrl,(dragger.img.complete||void 0===dragger.img.complete)&&(dragger.img.src=dragger.imgUrl)},transformImage:function(t,r){var e=dragger.canvas,a=dragger.ctx,g=r,n=dragger.img,s=0;n.crossOrigin="Anonymous",e.height=n.height,e.width=n.width,a.globalCompositeOperation="normal",a.fillStyle="#fff",a.fillRect(0,0,e.width,e.height),a.fill();var d=e.width>=e.height?"width":"height",l="width"===d?"height":"width",u=n[l]/n[d];n[l]=n[l]>dragger.targetWidth?dragger.targetWidth:n[l],n[l]=dragger.targetWidth,n[d]=n[l]/u;var s=.2*dragger.targetWidth;e[l]=dragger.targetWidth,e[d]=dragger.targetWidth;var c=document.createElement("canvas");c.width=e.width,c.height=e.height;var h=c.getContext("2d");h.translate(.5,.5),h.fillStyle="white",h.strokeStyle="#000",h.fillRect(0,0,c.width,c.height),h.globalCompositeOperation="destination-out",a.drawImage(c,0,0),a.moveTo(s/2,e.height/4),a.lineTo(e.width/2,0),a.lineTo(e.width-s/2,e.height/4),a.lineTo(e.width-s/2,e.height-e.height/4),a.lineTo(e.width/2,e.height),a.lineTo(s/2,e.height-e.height/4),a.lineTo(s/2,e.height/4),a.strokeStyle="#fff",a.lineWidth=5,a.stroke(),a.clip(),dragger.isDragging&&(o=t.ev.layerX-dragger.startDrag.x,i=t.ev.layerY-dragger.startDrag.y),o>s/2&&(o=s/2),o+n.width<e.width-s/2&&(o=e.width-s/2-n.width),a.drawImage(n,o,0,n.width,n.height),dragger.imgPos.x=o,dragger.imgPos.y=i;var m=a.getImageData(0,0,e.width,e.height),f=m.data;if(!dragger.isDragging)for(var p=0,w=f.length;w>p;p+=4){var y=.3*f[p]+.59*f[p+1]+.11*f[p+2];f[p]=y,f[p+1]=y,f[p+2]=y}if(a.putImageData(m,0,0),!dragger.isDragging){var v=document.createElement("IMG");v.onload=function(){v.width=e.width,v.height=e.height,a.drawImage(v,0,0,e.width,e.height),g(e.toDataURL("image/png"))},v.src="images/overlay.png",a.restore()}}},dragger.init(),t.$apply(function(){t.user=r,g.setUser(t.user)})})};var o=0,i=0});